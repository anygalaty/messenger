# Messenger

**Messenger** — это часть логики мессенджера, реализованная с использованием FastAPI. 
Демонстрационная реализация функционала обмена сообщениями и групповых чатов с использованием 
WebSocket и REST API.

## Возможности

- Реализация real-time обмена сообщениями через WebSocket.
- Создание личных и групповых чатов.
- Хранение сообщений в PostgreSQL.
- Обработка статуса прочтения сообщений.
- Уведомление отправителя, если его сообщение было прочитано всеми участниками.
- Индикатор `typing`, отображающий, когда пользователь набирает сообщение.
- Авторизация через JWT (доступ и обновление токенов через cookie).
- Асинхронная работа с базой данных (через SQLAlchemy async).
- Логирование действий и исключений.
- Обработка ошибок (в том числе централизованная).
- Поддержка темплейтов (Jinja2) и базовых стилей (в духе Telegram).

---

## Как запустить

1. Клонируйте репозиторий:

```
git clone https://github.com/anygalaty/messenger.git
cd messenger
```

2. Соберите и запустите проект через Docker Compose:

```
docker compose up --build
```

3. После запуска сервис будет доступен по адресу:

```
http://localhost:8000
```

4. Документация API:

```
http://localhost:8000/docs
```

---

## Загрузка тестовых данных

Для генерации тестовых пользователей, чатов и сообщений:

```http
POST /api/v1/test/test-data
```

После вызова создаются:

- Пользователи:
  - Андрей — `a@example.com`, пароль: `pass1`
  - Борис — `b@example.com`, пароль: `pass2`
  - Саша — `s@example.com`, пароль: `pass3`

- Личный чат между Андреем и Борисом.
- Группа "Test Group", созданная Андреем. Вступает также Саша.
- Несколько тестовых сообщений (в чате и одно в группе).

---

## Поведение сообщений

- Каждое сообщение содержит:
  - Уникальный ID
  - ID чата или группы
  - ID отправителя
  - Текст
  - Время создания
  - Статус `прочитано`

- При чтении сообщения отправляется WebSocket-событие `read` всем участникам.

- Как только все участники прочитали сообщение — отправителю приходит уведомление (`fully_read`).

- Поддержка событий `typing`: если пользователь начинает набирать сообщение, другие участники получают оповещение в режиме реального времени.

---

## Доступные страницы

1. Регистрация:  
   `host:port/register`

2. Логин:  
   `host:port/login`

3. Главная страница:
    `host:port/`

4. Чаты и группы:
    `host:port/messenger`

---

## Технологии

- **Язык**: Python 3.11
- **Фреймворк**: FastAPI
- **База данных**: PostgreSQL
- **ORM**: SQLAlchemy (async)
- **Миграции**: Alembic
- **Контейнеризация**: Docker + Docker Compose
- **Зависимости**: Poetry
- **WebSocket**: для real-time чатов и групп
- **Логирование**: встроенное и кастомное (по слоям `api`, `db`)
- **Асинхронность**: `asyncio`, `async SQLAlchemy`

---

## Структура проекта

```
messenger/
|-- api/                # Все маршруты FastAPI, сгруппированные по функционалу (auth, chats, messages и др.)
|   |-- v1/
|
|-- app/                # Основной запуск приложения и HTML-шаблоны (Jinja2)
|   |-- templates/
|
|-- core/               # Конфигурации, middleware, логгеры, безопасность, WebSocket менеджер, доступ к БД
|   |-- db/
|   |-- middleware/
|
|-- migrations/         # Alembic миграции для управления схемой БД
|   |-- versions/
|
|-- models/             # SQLAlchemy ORM-модели (User, Chat, Message, Group)
|
|-- schemas/            # Pydantic-схемы для валидации входных и выходных данных
|
|-- services/           # Бизнес-логика приложения, работа с базой данных
|
|-- static/             # CSS-стили для фронтенда
|   |-- css/
```
